name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  # Fast check on direct pushes to main only (not PRs)
  quick-test:
    if: github.event_name == 'push'
    runs-on: ubuntu-latest
    container:
      image: mcr.microsoft.com/devcontainers/cpp:ubuntu
    name: Quick Test (Release)

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install system dependencies
        run: |
          apt-get update
          apt-get install -y \
            libblas-dev \
            liblapack-dev \
            gfortran \
            ninja-build \
            python3-venv \
            python3-dev

      - name: Setup Python venv
        run: |
          python3 -m venv venv
          . venv/bin/activate
          pip install --upgrade pip setuptools wheel
          pip install -r requirements.txt

      - name: Configure CMake
        run: |
          . venv/bin/activate
          cmake --preset linux-x64-release

      - name: Build
        run: |
          . venv/bin/activate
          cmake --build --preset linux-x64-release-build

      - name: Install Python extension
        run: |
          . venv/bin/activate
          pip install -e .

      - name: Run tests
        run: |
          . venv/bin/activate
          pytest tests/python/ -v

  # Thorough checks on PR/manual trigger only
  full-test:
    if: github.event_name == 'pull_request' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    container:
      image: mcr.microsoft.com/devcontainers/cpp:ubuntu
    strategy:
      fail-fast: false
      matrix:
        preset:
          - name: sanitizers
            configure: linux-x64-debug-sanitizers
            build: linux-x64-debug-sanitizers-build

    name: Full Test (${{ matrix.preset.name }})

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install system dependencies
        run: |
          apt-get update
          apt-get install -y \
            libblas-dev \
            liblapack-dev \
            gfortran \
            ninja-build \
            python3-venv \
            python3-dev

      - name: Setup Python venv
        run: |
          python3 -m venv venv
          . venv/bin/activate
          pip install --upgrade pip setuptools wheel
          pip install -r requirements.txt

      - name: Configure CMake
        run: |
          . venv/bin/activate
          cmake --preset ${{ matrix.preset.configure }}

      - name: Build
        run: |
          . venv/bin/activate
          cmake --build --preset ${{ matrix.preset.build }}

      - name: Install Python extension
        run: |
          . venv/bin/activate
          pip install -e .

      - name: Run tests
        run: |
          . venv/bin/activate
          if [[ "${{ matrix.preset.name }}" == "sanitizers" ]]; then
            export LD_PRELOAD=$(gcc -print-file-name=libasan.so)
          fi
          pytest tests/python/ -v
        env:
          ASAN_OPTIONS: detect_leaks=0:symbolize=1:abort_on_error=1:verify_asan_link_order=0
          UBSAN_OPTIONS: print_stacktrace=1:halt_on_error=1
